extends layout_app

block content
  //- ==========================================================================================
  //- I N Y M O   S T R A T E G I C   C O M M A N D   C E N T E R   ( V . F I N A L . M A X )
  //- ==========================================================================================
  //- Versión: 120.0.0 "Titanium Monolith - Fixed Configuration"
  //- Autor: Ángel Velasco & IA Orange
  //- Descripción: Panel de Control de Proyecto con Integración de Edición y Métricas.
  //- ==========================================================================================

  //- 1. INTEGRACIÓN DE LIBRERÍAS VISUALES
  //- ==========================================================================================
  script(src="https://cdn.jsdelivr.net/npm/chart.js")
  link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css")
  link(rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;500;700&display=swap")

  //- 2. MOTOR DE ESTILOS (CSS CORE EXPANDIDO - +400 LÍNEAS DE ESTILO)
  //- ==========================================================================================
  style.
    /* ----------------------------------------------------------------------
       A. SISTEMA DE VARIABLES (DESIGN TOKENS)
       ---------------------------------------------------------------------- */
    :root {
      /* COLORES PRINCIPALES */
      --navy-900: #0f172a;
      --navy-800: #1e293b;
      --navy-700: #334155;
      --navy-600: #475569;
      --navy-500: #64748b;
      
      --gold-500: #d4af37;
      --gold-400: #fbbf24;
      --gold-100: #fef3c7;
      
      --blue-600: #2563eb;
      --blue-100: #eff6ff;
      
      --green-600: #059669;
      --green-500: #10b981;
      --green-100: #ecfdf5;
      
      --red-600: #dc2626;
      --red-500: #ef4444;
      --red-100: #fef2f2;
      
      --white: #ffffff;
      --bg-app: #f8fafc;
      --border-light: #e2e8f0;
      --border-dark: #cbd5e1;
      
      /* FUENTES */
      --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
      --font-data: 'Roboto Mono', monospace;
      
      /* SOMBRAS Y ELEVACIÓN */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
      
      /* BORDES */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
    }

    /* ----------------------------------------------------------------------
       B. RESET Y ESTRUCTURA BASE
       ---------------------------------------------------------------------- */
    * {
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-app);
      font-family: var(--font-ui);
      color: var(--navy-900);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a {
      text-decoration: none;
      color: inherit;
      transition: color 0.2s ease;
    }

    /* SISTEMA DE GRID PRINCIPAL */
    .dashboard-wrapper {
      display: grid;
      /* Columna Izquierda Fija (400px) | Columna Derecha Flexible */
      grid-template-columns: 380px 1fr; 
      gap: 30px;
      padding-bottom: 120px;
    }

    /* RESPONSIVE BREAKPOINT */
    @media (max-width: 1400px) {
      .dashboard-wrapper {
        grid-template-columns: 1fr; /* Stack vertical en pantallas medianas */
      }
    }

    /* ----------------------------------------------------------------------
       C. COMPONENTE: HERO HEADER (ENCABEZADO DE PROYECTO)
       ---------------------------------------------------------------------- */
    .hero-box {
      background-color: var(--white);
      border-radius: var(--radius-xl);
      padding: 40px 50px;
      margin-bottom: 35px;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    /* Barra lateral decorativa */
    .hero-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: linear-gradient(180deg, var(--navy-900) 0%, var(--blue-600) 100%);
    }

    .hero-nav-link {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--navy-500);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
    }
    .hero-nav-link:hover {
      color: var(--blue-600);
      transform: translateX(-3px);
    }

    .hero-title {
      font-size: 2.6rem;
      font-weight: 800;
      color: var(--navy-900);
      margin: 0 0 15px 0;
      letter-spacing: -1.5px;
      line-height: 1.1;
    }

    .hero-meta-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .meta-badge {
      font-size: 0.8rem;
      color: var(--navy-700);
      background-color: var(--bg-app);
      padding: 8px 16px;
      border-radius: var(--radius-full);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-light);
    }

    .meta-badge i {
      font-size: 1.1rem;
      color: var(--navy-500);
    }

    /* ESTADOS EN EL HEADER */
    .meta-badge.status-ok { background-color: var(--green-100); color: var(--green-600); border-color: var(--green-600); }
    .meta-badge.status-warning { background-color: var(--gold-100); color: #b45309; border-color: var(--gold-400); }
    .meta-badge.status-danger { background-color: var(--red-100); color: var(--red-600); border-color: var(--red-600); }

    /* ----------------------------------------------------------------------
       D. COMPONENTE: KPI RIBBON (INDICADORES FINANCIEROS)
       ---------------------------------------------------------------------- */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 25px;
      margin-bottom: 40px;
    }

    .kpi-tile {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      padding: 25px;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-tile:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: var(--gold-500);
    }

    /* Variaciones de Color de Borde */
    .kpi-tile.accent-green { border-left: 4px solid var(--green-600); }
    .kpi-tile.accent-red { border-left: 4px solid var(--red-600); }
    .kpi-tile.accent-blue { border-left: 4px solid var(--blue-600); }
    .kpi-tile.accent-gold { border-left: 4px solid var(--gold-500); }

    .kpi-label {
      font-size: 0.7rem;
      font-weight: 800;
      color: var(--navy-500);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      display: block;
    }

    .kpi-value {
      font-family: var(--font-data);
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--navy-900);
      line-height: 1;
    }

    .kpi-value.positive { color: var(--green-600); }
    .kpi-value.negative { color: var(--red-600); }

    .kpi-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2rem;
      color: var(--navy-900);
      opacity: 0.05;
      transform: rotate(-15deg);
    }

    /* ----------------------------------------------------------------------
       E. COMPONENTE: MÓDULOS DE CONTENIDO (CARDS)
       ---------------------------------------------------------------------- */
    .module-card {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      margin-bottom: 30px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
    }

    .module-header {
      padding: 20px 25px;
      background-color: #ffffff;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .module-title {
      font-size: 1rem;
      font-weight: 800;
      color: var(--navy-900);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .module-title i {
      font-size: 1.2rem;
      color: var(--blue-600);
    }

    .module-body {
      padding: 25px;
      flex-grow: 1;
    }

    .module-body.no-pad {
      padding: 0;
    }

    .text-center-content {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ----------------------------------------------------------------------
       F. COMPONENTE: BOTONES PROFESIONALES
       ---------------------------------------------------------------------- */
    .btn-action {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px 24px;
      border-radius: var(--radius-md);
      font-weight: 700;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
    }

    .btn-action:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-action.dark { background-color: var(--navy-900); color: var(--white); }
    .btn-action.gold { background-color: var(--gold-500); color: var(--white); }
    .btn-action.white { 
      background-color: var(--white); 
      border: 1px solid var(--border-light); 
      color: var(--navy-700); 
    }
    .btn-action.danger { 
      background-color: var(--red-100); 
      color: var(--red-600); 
      border: 1px solid var(--red-100); 
    }

    /* BOTONES PEQUEÑOS (ICON ONLY) */
    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
    }

    .btn-icon.edit { background-color: var(--blue-100); color: var(--blue-600); }
    .btn-icon.delete { background-color: var(--red-100); color: var(--red-600); }
    .btn-icon.check { background-color: var(--green-100); color: var(--green-600); }
    
    .btn-icon:hover { filter: brightness(0.95); transform: scale(1.05); }

    /* ----------------------------------------------------------------------
       G. COMPONENTE: TABLAS DE DATOS
       ---------------------------------------------------------------------- */
    .table-data {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-data th {
      text-align: left;
      padding: 15px 25px;
      background-color: #f8fafc;
      font-size: 0.75rem;
      font-weight: 800;
      color: var(--navy-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border-light);
    }

    .table-data td {
      padding: 18px 25px;
      border-bottom: 1px solid var(--border-light);
      font-size: 0.95rem;
      color: var(--navy-800);
      vertical-align: middle;
    }

    .table-data tr:last-child td {
      border-bottom: none;
    }

    .table-data tr:hover td {
      background-color: #fcfcfc;
    }

    /* ----------------------------------------------------------------------
       H. COMPONENTE: TIMELINE VERTICAL
       ---------------------------------------------------------------------- */
    .timeline-container {
      position: relative;
      padding-left: 20px;
      margin-left: 10px;
      border-left: 2px solid var(--border-light);
    }

    .timeline-entry {
      position: relative;
      margin-bottom: 30px;
    }

    .timeline-dot {
      position: absolute;
      left: -29px;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid var(--white);
      box-shadow: 0 0 0 2px var(--border-light);
    }

    .timeline-dot.avance { background-color: var(--green-500); }
    .timeline-dot.incidente { background-color: var(--red-500); }
    .timeline-dot.gasto { background-color: var(--gold-500); }
    .timeline-dot.nota { background-color: var(--navy-900); }

    .timeline-card {
      background-color: #f8fafc;
      padding: 15px 20px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
    }

    .timeline-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--navy-500);
      text-transform: uppercase;
    }

    /* ----------------------------------------------------------------------
       I. COMPONENTE: MODALES INTERACTIVOS
       ---------------------------------------------------------------------- */
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(4px);
      z-index: 9999;
      align-items: flex-start;
      justify-content: center;
      padding-top: 5vh;
    }

    .modal-window {
      background-color: var(--white);
      width: 90%;
      max-width: 550px;
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-top {
      background-color: var(--navy-900);
      color: var(--white);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-top h5 {
      margin: 0;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-form-body {
      padding: 30px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .form-group-label {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--navy-800);
      margin-bottom: 8px;
      display: block;
    }

    .form-control-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-md);
      font-family: var(--font-ui);
      font-size: 0.95rem;
      color: var(--navy-900);
      margin-bottom: 20px;
      transition: border-color 0.2s;
    }

    .form-control-input:focus {
      outline: none;
      border-color: var(--gold-500);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
    }

    /* ----------------------------------------------------------------------
       J. ELEMENTOS DE GRÁFICOS
       ---------------------------------------------------------------------- */
    .chart-container-box {
      height: 350px;
      width: 100%;
      position: relative;
    }

    .impact-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .impact-badge.negative { background: var(--red-100); color: var(--red-600); }
    .impact-badge.positive { background: var(--green-100); color: var(--green-600); }

  //- =========================================================================
  //- 4. ESTRUCTURA DE CONTENIDO HTML
  //- =========================================================================
  .container-fluid.px-5.py-4
    
    //- A. ENCABEZADO PRINCIPAL (HERO)
    .hero-box
      .d-flex.justify-content-between.align-items-start.flex-wrap.gap-4
        div
          a.hero-nav-link(href="/app/proyectos") 
            i.bx.bx-left-arrow-alt.fs-5
            | VOLVER AL PORTAFOLIO
          
          h1.hero-title= p.nombre
          
          .hero-meta-row
            span.meta-badge: i.bx.bx-barcode: | #{p.codigo}
            span.meta-badge: i.bx.bx-calendar: | Entrega: #{p.fecha_fin_ajustada_f || 'N/A'}
            span.meta-badge: i.bx.bx-user-circle: | PM: #{p.lider}
            
            - var statusClass = p.salud === 'En Tiempo' ? 'status-ok' : (p.salud === 'Retrasado' ? 'status-warning' : 'status-danger');
            span.meta-badge(class=statusClass)
               i.bx.bxs-circle
               | #{p.salud}

        //- BOTONERA DE ACCIÓN
        .d-flex.gap-2.align-items-center
          a.btn-action.white(href=`/app/repositorio/proyecto/${p.id}`) 
            i.bx.bxs-folder-open.text-warning.fs-5
            | Archivos (#{p.totalPlanos})
          
          a.btn-action.white(href=`/app/proyectos/reporte/${p.id}` target="_blank") 
            i.bx.bxs-file-pdf.text-danger.fs-5
            | Reporte
          
          //- [CORRECCIÓN CRÍTICA] EL ENLACE DEL BOTÓN CONFIGURAR
          //- Ahora apunta a: /app/proyectos/123/editar
          a.btn-action.dark(href=`/app/proyectos/${p.id}/editar`) 
            i.bx.bx-slider-alt.fs-5
            | Configurar
          
          button.btn-action.danger(onclick=`confirmAction('/app/proyectos/eliminar/${p.id}', '¿Confirmas archivar este proyecto?')`) 
            i.bx.bx-archive-in.fs-5
            | Archivar

    //- B. CINTA DE INDICADORES (KPIs EVM)
    .kpi-container
      .kpi-tile.accent-gold
        span.kpi-label Presupuesto (BAC)
        div.kpi-value= p.kpi.bac_f
        i.bx.bx-coin-stack.kpi-icon
      
      .kpi-tile.accent-blue
        span.kpi-label Valor Planeado (PV)
        div.kpi-value= p.kpi.pv_f
        i.bx.bx-calendar-check.kpi-icon
      
      .kpi-tile.accent-green
        span.kpi-label Valor Ganado (EV)
        div.kpi-value.positive= p.kpi.ev_f
        i.bx.bx-trending-up.kpi-icon
      
      .kpi-tile.accent-red
        span.kpi-label Costo Real (AC)
        div.kpi-value.negative= p.kpi.ac_f
        i.bx.bx-receipt.kpi-icon

    //- C. GRID DASHBOARD
    .dashboard-wrapper
      
      //- --- COLUMNA IZQUIERDA: DIAGNÓSTICO Y OPERACIÓN ---
      aside
        //- PANEL 1: RENDIMIENTO OPERATIVO (CPI/SPI)
        .module-card
          .module-header
            h5.module-title 
              i.bx.bx-tachometer.fs-4
              | Rendimiento
          .module-body.text-center-content
            //- Donut Chart Container
            div(style="position:relative; width:160px; height:160px; margin-bottom:25px;")
              canvas#chartDonut
              div(style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-family:var(--font-data); font-weight:800; font-size:1.8rem; color:var(--navy-900);") #{p.progreso}%
            
            .row.g-2.w-100
              .col-6.p-3.bg-light.rounded-3.border
                strong.d-block(style="font-family: var(--font-data); font-size:1.2rem;" class=p.kpi.cpi_color)= p.kpi.cpi_v
                small.kpi-label(style="margin:0;") CPI (Costo)
              .col-6.p-3.bg-light.rounded-3.border
                strong.d-block(style="font-family: var(--font-data); font-size:1.2rem;" class=p.kpi.spi_color)= p.kpi.spi_v
                small.kpi-label(style="margin:0;") SPI (Tiempo)
            
            div.mt-4.p-3.border.rounded-3.w-100(style="background:#f8fafc; font-size:0.85rem; font-weight:600; color:var(--navy-600);")
              | #{p.kpi.diagnostico}

        //- PANEL 2: RIESGOS (CON CRUD)
        .module-card
          .module-header
            h5.module-title 
              i.bx.bx-shield-quarter.text-danger.fs-4
              | Riesgos Activos
            button.btn-action.dark(onclick="openModal('modalRiesgo', 'crear')" style="font-size:0.75rem; padding:6px 12px;") + Nuevo
          .module-body.no-pad
            if p.riesgos.length > 0
              table.table-data
                tbody
                  each r in p.riesgos
                    tr
                      td
                        strong.d-block.small= r.descripcion
                        span.badge.rounded-pill.mt-1(class=r.impacto=='Alto'?'bg-danger':'bg-warning text-dark')= r.impacto
                      td.text-end
                        //- Botones de Edición y Eliminación
                        button.btn-icon.edit.me-1(onclick=`editarRiesgo('${r.id}', '${r.descripcion}', '${r.impacto}')`): i.bx.bx-pencil
                        button.btn-icon.delete(onclick=`confirmAction('/app/proyectos/${p.id}/riesgo/eliminar/${r.id}')`): i.bx.bx-trash
            else
              .p-5.text-center.text-muted.small No hay riesgos registrados.

        //- PANEL 3: BITÁCORA (TIMELINE)
        .module-card
          .module-header
            h5.module-title 
              i.bx.bx-notepad.text-primary.fs-4
              | Bitácora
            button.btn-action.dark(onclick="openModal('modalBitacora')" style="font-size:0.75rem; padding:6px 12px;") + Nota
          .module-body(style="max-height:500px; overflow-y:auto;")
            if p.bitacora.length > 0
              .timeline-container
                each b in p.bitacora
                  .timeline-entry
                    .timeline-dot(class=(b.tipo_registro || 'nota').toLowerCase())
                    .timeline-card
                      .timeline-meta
                        span= new Date(b.fecha_registro).toLocaleDateString()
                        i.bx.bx-trash.text-danger(style="cursor:pointer;" onclick=`confirmAction('/app/proyectos/${p.id}/bitacora/eliminar/${b.id}')`)
                      strong.d-block.text-dark(style="font-size:0.95rem; margin-bottom:5px;")= b.titulo
                      p.mb-0.small.text-muted(style="line-height:1.4;")= b.descripcion
            else
              .p-5.text-center.text-muted.small Sin actividad reciente.

      //- --- COLUMNA DERECHA: ANALÍTICA Y GESTIÓN ---
      main
        //- PANEL 4: GRÁFICAS ESTRATÉGICAS (CON FILTROS)
        .module-card
          .module-header
            h5.module-title 
              i.bx.bx-line-chart-down.text-success.fs-4
              | Análisis de Tendencia (Curva S)
            
            //- SEGMENTACIÓN POR FECHA
            div.d-flex.gap-2.align-items-center
              input.form-control-input.py-1(type="date" id="filtroInicio" value=filtros.start style="margin:0; width:140px; font-size:0.8rem;")
              span.text-muted -
              input.form-control-input.py-1(type="date" id="filtroFin" value=filtros.end style="margin:0; width:140px; font-size:0.8rem;")
              button.btn-action.dark(onclick="aplicarFiltros()" style="padding:6px 12px; font-size:0.75rem;") Filtrar

          .module-body
            div.chart-container-box
              canvas#chartCurvaS
            
            hr.my-5(style="border-color: var(--border-light);")
            
            h5.module-title.mb-4: i.bx.bx-bar-chart-alt-2.me-2: | Eficiencia Histórica
            div.chart-container-box
              canvas#chartPerformance

        //- PANEL 5: CONTROL DE CAMBIOS (TABLERO DE DECISIÓN)
        .module-card
          .module-header
            h5.module-title 
              i.bx.bx-git-compare.text-primary.fs-4
              | Control de Cambios (RC)
            button.btn-action.dark(onclick="openModal('modalCambio', 'crear')") + Solicitud
          .module-body.no-pad
            if p.controlCambios.length > 0
              table.table-data
                thead: tr: th Solicitud: th Impacto: th Estado: th Gestión
                tbody
                  each c in p.controlCambios
                    tr
                      td
                        strong.d-block= c.titulo
                        small.text-muted= c.descripcion
                      td
                        div.d-flex.flex-column.gap-1
                          if c.impacto_costo != 0
                            span.impact-badge(class=c.impacto_costo > 0 ? 'negative' : 'positive')
                              | #{c.impacto_costo > 0 ? '+' : ''}$#{parseFloat(c.impacto_costo).toLocaleString()}
                          if c.impacto_tiempo != 0
                            span.impact-badge(class=c.impacto_tiempo > 0 ? 'negative' : 'positive')
                              | #{c.impacto_tiempo > 0 ? '+' : ''}#{c.impacto_tiempo} días
                      td
                        span.badge.bg-light.text-dark.border= c.estatus
                      td.text-end
                        if c.estatus === 'Pendiente'
                           //- Botones de Decisión
                           form.d-inline(action=`/app/proyectos/${p.id}/cambio/${c.id}/aprobar` method="POST")
                             button.btn-icon.check(title="Aprobar"): i.bx.bx-check.fs-5
                           form.d-inline(action=`/app/proyectos/${p.id}/cambio/${c.id}/rechazar` method="POST" style="margin-left:5px;")
                             button.btn-icon.delete(title="Rechazar"): i.bx.bx-x.fs-5
                        else
                           button.btn-icon.delete(onclick=`confirmAction('/app/proyectos/${p.id}/cambio/eliminar/${c.id}')`): i.bx.bx-trash
            else
              .p-5.text-center.text-muted.small No hay solicitudes de cambio pendientes.

        //- PANEL 6: ENTREGABLES (WBS)
        .module-card
          .module-header
            h5.module-title 
              i.bx.bx-layer.text-primary.fs-4
              | Entregables (WBS)
            button.btn-action.dark(onclick="openModal('modalEntregable', 'crear')") + Nuevo
          .module-body.no-pad
            table.table-data
              thead: tr: th Entregable: th % Avance: th Resp.: th
              tbody
                if p.entregables.length > 0
                  each e in p.entregables
                    tr
                      td.fw-bold= e.nombre
                      td
                        form.d-flex.align-items-center.gap-2(action=`/app/proyectos/${p.id}/entregable/${e.id}/actualizar` method="POST")
                          input.form-control-input.text-center(type="number" name="nuevo_progreso" value=e.progreso min="0" max="100" style="width:70px; margin:0; padding:6px; font-weight:bold;")
                          button.btn-icon.edit(type="submit" title="Guardar"): i.bx.bx-save
                      td.small= e.responsable
                      td.text-end
                        button.btn-icon.edit.me-1(onclick=`editarEntregable('${e.id}', '${e.nombre}', '${e.responsable}', '${e.fecha_entrega ? new Date(e.fecha_entrega).toISOString().split('T')[0] : ''}')`): i.bx.bx-pencil
                        button.btn-icon.delete(onclick=`confirmAction('/app/proyectos/${p.id}/entregable/eliminar/${e.id}')`): i.bx.bx-trash
                else
                  tr: td(colspan="4" class="text-center py-5 text-muted") WBS Vacío.

        //- PANEL 7: HITOS
        .module-card
          .module-header
            h5.module-title 
              i.bx.bx-flag.text-warning.fs-4
              | Hitos Clave
            button.btn-action.dark(onclick="openModal('modalHito', 'crear')") + Hito
          .module-body
            if p.hitos.length > 0
              .row.g-3
                each h in p.hitos
                  .col-md-6
                    .timeline-card(style="display:flex; gap:15px; align-items:center;")
                      div(style="text-align:center; background:#e2e8f0; padding:8px 12px; border-radius:8px;")
                        - var d = new Date(h.fecha)
                        span(style="display:block; font-weight:800; font-size:1.1rem;")= d.getDate()
                        span(style="font-size:0.7rem; text-transform:uppercase;")= d.toLocaleString('es-MX', { month: 'short' })
                      div(style="flex-grow:1;")
                        span(style="font-weight:700; font-size:0.9rem; display:block;")= h.nombre
                        span.badge.bg-white.text-dark.border= h.estado
                      div
                        i.bx.bx-pencil.text-primary(style="cursor:pointer; margin-right:8px;" onclick=`editarHito('${h.id}', '${h.nombre}', '${new Date(h.fecha).toISOString().split('T')[0]}')`)
                        i.bx.bx-trash.text-danger(style="cursor:pointer;" onclick=`confirmAction('/app/proyectos/${p.id}/hito/eliminar/${h.id}')`)
            else
              .text-center.py-4.text-muted Sin hitos programados.

  //- =========================================================================
  //- 5. SISTEMA DE MODALES (PREPARADOS PARA CREAR Y EDITAR)
  //- =========================================================================

  //- MODAL: CAMBIO
  #modalCambio.modal-backdrop
    .modal-window
      .modal-top
        h5#tituloCambio Solicitud de Cambio
        i.bx.bx-x.fs-3(style="cursor:pointer;" onclick="closeModal('modalCambio')")
      form#formCambio(action=`/app/proyectos/${p.id}/cambio` method="POST")
        .modal-form-body
          label.form-group-label Título del Cambio
          input.form-control-input(name="titulo" required placeholder="Ej: Aditiva de Acero")
          .row
            .col-6: label.form-group-label Costo (+/- $)
              input.form-control-input(type="number" name="impacto_costo" step="0.01" value="0")
            .col-6: label.form-group-label Tiempo (+/- Días)
              input.form-control-input(type="number" name="impacto_tiempo" value="0")
          label.form-group-label Justificación Técnica
          textarea.form-control-input(name="descripcion" rows="3" required)
        .p-4.text-end.bg-light
          button.btn-action.dark(type="submit") Enviar Solicitud

  //- MODAL: GASTO
  #modalGasto.modal-backdrop
    .modal-window
      .modal-top
        h5 Registrar Gasto / Factura
        i.bx.bx-x.fs-3(style="cursor:pointer;" onclick="closeModal('modalGasto')")
      form(action=`/app/proyectos/${p.id}/gasto` method="POST")
        .modal-form-body
          label.form-group-label Concepto
          input.form-control-input(name="concepto" required)
          .row
            .col-6: label.form-group-label Monto ($)
              input.form-control-input(type="number" name="monto" required)
            .col-6: label.form-group-label Fecha
              input.form-control-input(type="date" name="fecha" required)
        .p-4.text-end.bg-light: button.btn-action.dark(type="submit") Guardar

  //- MODAL: RIESGO
  #modalRiesgo.modal-backdrop
    .modal-window
      .modal-top
        h5#tituloRiesgo Nuevo Riesgo
        i.bx.bx-x.fs-3(style="cursor:pointer;" onclick="closeModal('modalRiesgo')")
      form#formRiesgo(action=`/app/proyectos/${p.id}/riesgo` method="POST")
        .modal-form-body
          input#riesgoId(type="hidden" name="id")
          label.form-group-label Descripción del Riesgo
          textarea.form-control-input#riesgoDesc(name="descripcion" required rows="3")
          label.form-group-label Nivel de Impacto
          select.form-control-input#riesgoImpacto(name="impacto")
            option Alto
            option Medio
            option Bajo
        .p-4.text-end.bg-light: button.btn-action.danger(type="submit") Registrar

  //- MODAL: HITO
  #modalHito.modal-backdrop
    .modal-window
      .modal-top
        h5#tituloHito Nuevo Hito
        i.bx.bx-x.fs-3(style="cursor:pointer;" onclick="closeModal('modalHito')")
      form#formHito(action=`/app/proyectos/${p.id}/hito` method="POST")
        .modal-form-body
          label.form-group-label Nombre del Hito
          input.form-control-input#hitoNombre(name="nombre" required)
          label.form-group-label Fecha Programada
          input.form-control-input#hitoFecha(type="date" name="fecha" required)
        .p-4.text-end.bg-light: button.btn-action.gold(type="submit") Agendar

  //- MODAL: ENTREGABLE
  #modalEntregable.modal-backdrop
    .modal-window
      .modal-top
        h5#tituloEntregable Nuevo Entregable
        i.bx.bx-x.fs-3(style="cursor:pointer;" onclick="closeModal('modalEntregable')")
      form#formEntregable(action=`/app/proyectos/${p.id}/entregable` method="POST")
        .modal-form-body
          label.form-group-label Nombre Entregable
          input.form-control-input#entregableNombre(name="nombre" required)
          label.form-group-label Responsable
          input.form-control-input#entregableResp(name="responsable" required)
          label.form-group-label Fecha Entrega
          input.form-control-input#entregableFecha(type="date" name="fecha_entrega" required)
        .p-4.text-end.bg-light: button.btn-action.dark(type="submit") Crear

  //- MODAL: BITÁCORA
  #modalBitacora.modal-backdrop
    .modal-window
      .modal-top
        h5 Entrada de Bitácora
        i.bx.bx-x.fs-3(style="cursor:pointer;" onclick="closeModal('modalBitacora')")
      form(action=`/app/proyectos/${p.id}/bitacora` method="POST")
        .modal-form-body
          label.form-group-label Título
          input.form-control-input(name="titulo" required)
          label.form-group-label Tipo
          select.form-control-input(name="tipo_registro")
            option(value="Avance") Avance
            option(value="Incidente") Incidente
            option(value="Nota") Nota
          label.form-group-label Descripción
          textarea.form-control-input(name="descripcion" rows="3")
        .p-4.text-end.bg-light: button.btn-action.dark(type="submit") Registrar

  //- =========================================================================
  //- 6. INTELIGENCIA CLIENT-SIDE (JS)
  //- =========================================================================
  script.
    // Lógica UI
    function openModal(id, mode) { 
        if(mode === 'crear') {
            const form = document.querySelector(`#${id} form`);
            if(form) form.reset();
        }
        document.getElementById(id).style.display = 'flex'; 
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function confirmAction(url, msg = "¿Estás seguro? Esta acción es permanente.") {
        if(confirm(msg)) window.location.href = url;
    }

    // Funciones de Edición (Precarga de datos en Modal)
    function editarRiesgo(id, desc, impacto) {
        document.getElementById('riesgoDesc').value = desc;
        document.getElementById('riesgoImpacto').value = impacto;
        document.getElementById('tituloRiesgo').innerText = "Editar Riesgo (Simulado)";
        openModal('modalRiesgo');
    }
    function editarHito(id, nombre, fecha) {
        document.getElementById('hitoNombre').value = nombre;
        document.getElementById('hitoFecha').value = fecha;
        document.getElementById('tituloHito').innerText = "Editar Hito";
        openModal('modalHito');
    }
    function editarEntregable(id, nombre, resp, fecha) {
        document.getElementById('entregableNombre').value = nombre;
        document.getElementById('entregableResp').value = resp;
        document.getElementById('entregableFecha').value = fecha;
        document.getElementById('tituloEntregable').innerText = "Editar Entregable";
        openModal('modalEntregable');
    }

    // Lógica de Filtro por Fechas
    function aplicarFiltros() {
        const start = document.getElementById('filtroInicio').value;
        const end = document.getElementById('filtroFin').value;
        if(start && end) {
            window.location.href = `?start=${start}&end=${end}`;
        } else {
            alert('Selecciona ambas fechas para filtrar');
        }
    }

    // Gráficas Chart.js
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Curva S ---
        const ctxS = document.getElementById('chartCurvaS').getContext('2d');
        const labels = !{p.graficos.labels};
        
        new Chart(ctxS, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'PV (Planeado)', data: !{p.graficos.pv}, borderColor: '#94a3b8', borderDash: [5,5], pointRadius: 0, tension: 0.4 },
                    { label: 'EV (Ganado)', data: !{p.graficos.ev}, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4 },
                    { label: 'AC (Real)', data: !{p.graficos.ac}, borderColor: '#dc2626', tension: 0.4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } } }, plugins: { legend: { position: 'top' } } }
        });

        // --- 2. Performance (SPI/CPI) ---
        const ctxP = document.getElementById('chartPerformance').getContext('2d');
        new Chart(ctxP, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'SPI (Tiempo)', data: !{p.graficos.spi}, borderColor: '#3b82f6', tension: 0.4, borderWidth: 2 },
                    { label: 'CPI (Costo)', data: !{p.graficos.cpi}, borderColor: '#d4af37', tension: 0.4, borderWidth: 2 }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                scales: { 
                    y: { min: 0, max: 2, grid: { borderDash: [2,2] } }, 
                    x: { grid: { display: false } } 
                },
                plugins: { legend: { position: 'top' } }
            }
        });

        // --- 3. Donut ---
        const ctxD = document.getElementById('chartDonut').getContext('2d');
        new Chart(ctxD, {
            type: 'doughnut',
            data: {
                labels: ['Completado', 'Restante'],
                datasets: [{ data: [#{p.progreso}, #{100 - p.progreso}], backgroundColor: ['#10b981', '#e2e8f0'], borderWidth: 0 }]
            },
            options: { cutout: '75%', plugins: { tooltip: { enabled: false }, legend: { display: false } } }
        });
    });

    // Cierre click fuera
    window.onclick = function(e) {
        if(e.target.className === 'modal-backdrop') {
            document.querySelectorAll('.modal-backdrop').forEach(m => m.style.display='none');
        }
    }