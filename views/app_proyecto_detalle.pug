extends layout_app

block content
  link(rel='stylesheet', href='/stylesheets/proyecto_detalle.css')
  // Estilos r谩pidos para los Modales
  style.
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border-radius: 12px; width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .btn-add { background: #dcfce7; color: #166534; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8em; float: right; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; }
    .btn-submit { width: 100%; background: #1e293b; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; }

  // --- ENCABEZADO ---
  div.detail-header
    div
      a.back-link(href="/app/proyectos") 
        i.bx.bx-left-arrow-alt
        | Volver al Portafolio
      h1= p.nombre
      div.meta-tags
        span.tag.navy= p.codigo
        span.tag.green= p.salud
        span.tag.outline= p.lider

    div.header-actions
      //- BOTN NUEVO DEL REPOSITORIO (UBICACIN CORRECTA)
      a.btn-action.warning(href=`/app/repositorio/proyecto/${p.id}` style="background-color: #fef08a; color: #854d0e; border: 1px solid #eab308;") 
        i.fas.fa-folder-open
        if p.totalPlanos > 0
           |  Ver #{p.totalPlanos} Planos
        else
           |  Repositorio (Vac铆o)

      a.btn-action.secondary(href=`/app/proyectos/reporte/${p.id}`) Reporte PDF
      a.btn-action.primary(href=`/app/proyectos/editar/${p.id}`) Editar Proyecto
      a.btn-action.delete-btn(href=`/app/proyectos/eliminar/${p.id}`) 
        i.bx.bx-archive
        |  Archivar

  // --- GRID PRINCIPAL ---
  div.detail-grid
    
    // COLUMNA IZQUIERDA
    div.left-panel
      div.detail-card
        h3 KPIs Financieros (EVM)
        div.finance-circle-container(style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;")
          div.progress-donut(style=`width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(#65a30d ${p.progreso || 0}%, #e2e8f0 0); display: flex; align-items: center; justify-content: center; position: relative;`)
            div.inner-circle(style="width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; color: #3f6212;")
              | #{p.progreso || 0}%

          div.finance-info(style="flex-grow: 1;")
            p Presupuesto (BAC): 
              strong= p.bac_f
            
            //- Cierre Estimado din谩mico
            p(style="margin-top: 5px; padding-top: 5px; border-top: 1px dashed #e2e8f0;") 
              span(style="font-size: 0.85em; color: #64748b;") Cierre Estimado: 
              strong(style="color: #4f46e5;")= p.fecha_fin_ajustada_f || 'Pendiente'

            p(style="margin-top: 5px;") Valor Planeado (PV): 
              strong= p.pv_f
            p Costo Real (AC): 
              strong= p.ac_f

        hr.separator
        div.metric-item
          span.label CPI (Costo)
          strong(class=parseFloat(p.cpi_v) < 1.0 ? 'red-text' : 'green-text')= p.cpi_v
        div.metric-item
          span.label SPI (Tiempo)
          strong(class=parseFloat(p.spi_v) < 1.0 ? 'red-text' : 'green-text')= p.spi_v

        hr.separator.small
        div.metric-item
          span.label Estimaci贸n Final (EAC)
          strong= p.eac_f
        div.metric-item
          span.label Variaci贸n Costo (CV)
          - var cvColor = (p.cv_f && p.cv_f.toString().includes('-')) ? 'red-text' : 'green-text'
          strong(class=cvColor)= p.cv_f
      
      div.detail-card
          h3 
            | Matriz de Riesgos
            button.btn-add(onclick="openModal('modalRiesgo')") + Riesgo
          ul.risk-list
            if p.riesgos && p.riesgos.length > 0
              each r in p.riesgos
                li.risk-item
                  div
                    strong= r.descripcion
                  span.risk-badge(class=(r.impacto || 'bajo').toLowerCase())= r.impacto
            else
              li.risk-item(style="color: #94a3b8; font-style: italic;") No hay riesgos registrados.

    // COLUMNA DERECHA
    div.right-panel
      div.detail-card
        h3 
          | Historial de Progreso
          button.btn-add(onclick="openModal('modalBitacora')") + Bit谩cora
        
        div.calendar-grid-container
          div.calendar-grid
            each dia in p.historialDiario
              - var diaNum = (dia.displayFecha || '').split(' ')[0] || '-'
              - var diaMes = (dia.displayFecha || '').split(' ')[1] || '-'
              div.calendar-day(style=`background-color: ${dia.clase === 'fin-semana' ? '#a855f7' : (dia.clase === 'avance' ? '#22c55e' : (dia.clase === 'parado' ? '#ef4444' : '#f1f5f9'))};` title=`${dia.displayFecha}: ${dia.obs || 'Sin actividad'}`)
                span.day-num(style="font-size: 0.8em; font-weight: bold;")= diaNum
                span.day-name(style="font-size: 0.7em;")= diaMes
          
          div.calendar-legend
            span.legend-item(style="background-color: #22c55e;") Avance
            span.legend-item(style="background-color: #f1f5f9;") Normal
            span.legend-item(style="background-color: #ef4444;") Incidente

      div.detail-card
          h3 
            | Hitos Programados
            button.btn-add(onclick="openModal('modalHito')") + Hito
          div.timeline
            if p.hitos && p.hitos.length > 0
              each h in p.hitos
                div.timeline-item
                  div.timeline-content
                    strong= h.nombre
                    span(style="font-size: 0.85em; color: #64748b;")= h.fecha ? new Date(h.fecha).toLocaleDateString('es-MX') : ''
                  div(style="text-align:right;")
                    span.status-label(class=(h.estado || '').toLowerCase())= h.estado
            else
              p(style="color: #94a3b8; padding: 10px; text-align: center;") No hay hitos registrados.

  // --- SECCIONES INFERIORES ---
  div.control-operativo-grid
    div.detail-card.wbs-card
      h3 
        | Matriz de Alcance (Entregables)
        button.btn-add(onclick="openModal('modalEntregable')") + Entregable
      
      div(style="overflow-x: auto;")
        table.wbs-table(style="width: 100%; border-collapse: collapse;")
          thead
            tr(style="text-align: left; background: #f8fafc; border-bottom: 2px solid #e2e8f0;")
              th(style="padding: 12px; font-size: 0.85em; color: #64748b;") Entregable
              //- Le damos ancho fijo a esta columna para que quepa el bot贸n
              th(style="padding: 12px; font-size: 0.85em; color: #64748b; width: 160px;") Avance Real
              th(style="padding: 12px; font-size: 0.85em; color: #64748b;") Responsable
              th(style="padding: 12px; font-size: 0.85em; color: #64748b;") Estado
          tbody
            if p.entregables && p.entregables.length > 0
              each e in p.entregables
                tr(style="border-bottom: 1px solid #f1f5f9;")
                  td(style="padding: 12px; font-weight: 500;")= e.nombre
                  
                  //- FORMULARIO DE AVANCE CORREGIDO
                  td(style="padding: 8px;")
                    form(action=`/app/proyectos/${p.id}/entregable/${e.id}/actualizar` method="POST" style="display: flex; align-items: center; gap: 10px; margin: 0;")
                      
                      //- Input num茅rico peque帽o
                      div(style="position: relative; width: 70px;")
                        input(type="number" name="nuevo_progreso" value=e.progreso min="0" max="100" style="width: 100%; padding: 6px; border: 1px solid #94a3b8; border-radius: 6px; font-size: 0.9em; text-align: center; font-weight: bold;")
                        span(style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 0.7em; color: #64748b; pointer-events: none;") %
                      
                      //- Bot贸n de Guardar (Visible y Azul)
                      button(type="submit" style="border: none; background: #ffffffff; color: white; border-radius: 6px; width: 34px; height: 34px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" title="Guardar Porcentaje") 
                        span(style="font-size: 1.2em;") 
                  
                  td(style="padding: 12px; color: #475569;")= e.responsable
                  td(style="padding: 12px;")
                    span.status(class=(e.estado || '').toLowerCase().replace(' ', '-') style="padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; background: #f1f5f9; color: #475569;")= e.estado
            else
              tr
                td(colspan="4" style="text-align: center; padding: 20px; color: #94a3b8;") No hay entregables definidos.


    div.detail-card.changes-card
      h3 
        | Control de Cambios
        button.btn-add(style="background: #e0f2fe; color: #0284c7;" onclick="openModal('modalCambio')") + Cambio
      ul.changes-list
        if p.controlCambios && p.controlCambios.length > 0
          each c in p.controlCambios
            li.change-item(class=(c.estatus || '').toLowerCase())
              div(style="flex-grow: 1;")
                strong= c.titulo
                div.change-meta(style="display: flex; gap: 15px; font-size: 0.9em; margin-top: 5px;")
                  
                  if c.impacto_costo != 0
                    span.impact(style=`color: ${c.impacto_costo > 0 ? '#dc2626' : '#16a34a'}; font-weight: 600;`)
                      | #{c.impacto_costo > 0 ? '+' : ''}$#{parseFloat(c.impacto_costo).toLocaleString('es-MX', {minimumFractionDigits: 2})}
                  
                  if c.impacto_tiempo != 0
                    span.impact(style=`color: ${c.impacto_tiempo > 0 ? '#dc2626' : '#16a34a'}; font-weight: 600;`)
                      i.bx.bx-time-five(style="margin-right: 3px;")
                      | #{c.impacto_tiempo > 0 ? '+' : ''}#{c.impacto_tiempo} d铆as

                  if c.impacto_costo == 0 && c.impacto_tiempo == 0
                    span(style="color: #94a3b8;") Sin impacto material

                  span.status-badge(style="margin-left: auto; font-size: 0.8em; padding: 2px 8px; border-radius: 10px; background: #f1f5f9; color: #64748b;")= c.estatus
              
              if c.estatus === 'Pendiente'
                div.change-actions(style="display: flex; gap: 8px; align-items: center;")
                  form(action=`/app/proyectos/${p.id}/cambio/${c.id}/aprobar` method="POST" style="margin:0;")
                    button(type="submit" style="background: none; border: none; cursor: pointer; color: #16a34a; transition: transform 0.2s;" title="Aprobar") 
                      i.bx.bx-check-circle(style="font-size: 1.8em;")
                  
                  form(action=`/app/proyectos/${p.id}/cambio/${c.id}/rechazar` method="POST" style="margin:0;")
                    button(type="submit" style="background: none; border: none; cursor: pointer; color: #dc2626; transition: transform 0.2s;" title="Rechazar") 
                      i.bx.bx-x-circle(style="font-size: 1.8em;")
        else
          li.change-item(style="color: #94a3b8;") Sin cambios registrados.

  // --- SECCIN: REPORTE EJECUTIVO ---
  div.report-sections-row
    div.detail-card.full-width
      h3 Prioridades Estrat茅gicas (Pr贸ximos 30 D铆as)
      div.narrative-content
        p= p.metas_proximos_pasos || 'Definir prioridades para el pr贸ximo mes.'

    div.sections-container(style="display: flex; gap: 20px; width: 100%;")
      div.detail-card(style="flex: 1;")
        h3 Reporte de Estatus Ejecutivo
        p= p.narrativa || 'Sin resumen ejecutivo disponible.'

      div.detail-card(style="flex: 1;")
        h3 Lecciones Aprendidas (Knowledge Management)
        ul.lessons-list
          if p.leccionesAprendidas && p.leccionesAprendidas.length > 0
            each l in p.leccionesAprendidas
              li.lesson-item= l.titulo
          else
            li.lesson-item.empty No se han consolidado lecciones.

  // --- MODALES (VENTANAS EMERGENTES) ---
  
  // 1. MODAL ENTREGABLE
  div#modalEntregable.modal
    div.modal-content
      span.close(onclick="closeModal('modalEntregable')") &times;
      h3 Nuevo Entregable
      form(action=`/app/proyectos/${p.id}/entregable` method="POST")
        div.form-group
          label Nombre del Entregable
          input(type="text" name="nombre" required placeholder="Ej: Cimentaci贸n Nave A")
        div.form-group
          label Responsable
          input(type="text" name="responsable" required placeholder="Ing. Responsable")
        div.form-group
          label Fecha Compromiso
          input(type="date" name="fecha_entrega" required)
        div.form-group
          label Progreso Inicial (%)
          input(type="number" name="progreso" min="0" max="100" value="0")
        button.btn-submit(type="submit") Guardar Entregable

  // 2. MODAL RIESGO
  div#modalRiesgo.modal
    div.modal-content
      span.close(onclick="closeModal('modalRiesgo')") &times;
      h3 Nuevo Riesgo Detectado
      form(action=`/app/proyectos/${p.id}/riesgo` method="POST")
        div.form-group
          label Descripci贸n del Riesgo
          textarea(name="descripcion" rows="3" required placeholder="Ej: Retraso en entrega de acero por lluvias")
        div.form-group
          label Impacto Estimado
          select(name="impacto")
            option(value="Bajo") Bajo
            option(value="Medio") Medio
            option(value="Alto") Alto
        button.btn-submit(type="submit") Registrar Riesgo

  // 3. MODAL HITO
  div#modalHito.modal
    div.modal-content
      span.close(onclick="closeModal('modalHito')") &times;
      h3 Nuevo Hito Importante
      form(action=`/app/proyectos/${p.id}/hito` method="POST")
        div.form-group
          label Nombre del Hito
          input(type="text" name="nombre" required placeholder="Ej: Inicio de Montaje")
        div.form-group
          label Fecha Programada
          input(type="date" name="fecha" required)
        button.btn-submit(type="submit") Agendar Hito

  // 4. MODAL BITCORA
  div#modalBitacora.modal
    div.modal-content
      span.close(onclick="closeModal('modalBitacora')") &times;
      h3 Registrar en Bit谩cora (Hoy)
      form(action=`/app/proyectos/${p.id}/bitacora` method="POST")
        div.form-group
          label T铆tulo Corto
          input(type="text" name="titulo" required placeholder="Ej: Avance de Obra")
        div.form-group
          label Tipo de Registro
          select(name="tipo_registro")
            option(value="Avance") Avance (Verde)
            option(value="Incidente") Incidente (Rojo)
            option(value="Nota") Nota General (Azul)
        div.form-group
          label Detalles
          textarea(name="descripcion" rows="3" placeholder="Descripci贸n de lo ocurrido hoy...")
        button.btn-submit(type="submit") Guardar Registro
  
  // 5. MODAL CONTROL DE CAMBIOS
  div#modalCambio.modal
    div.modal-content
      span.close(onclick="closeModal('modalCambio')") &times;
      h3 Registrar Solicitud de Cambio (RC)
      form(action=`/app/proyectos/${p.id}/cambio` method="POST")
        div.form-group
          label T铆tulo del Cambio
          input(type="text" name="titulo" required placeholder="Ej: Cambio de especificaci贸n en Pisos")
        div.form-group
          label Justificaci贸n / Descripci贸n
          textarea(name="descripcion" rows="2" placeholder="Raz贸n del cambio...")
        div.form-group(style="display: flex; gap: 10px;")
          div(style="flex: 1;")
            label Impacto Costo ($)
            input(type="number" name="impacto_costo" step="0.01" placeholder="0.00")
            small(style="color: #64748b; font-size: 0.7em;") Usar negativo (-) para ahorros.
          div(style="flex: 1;")
            label Impacto Tiempo (D铆as)
            input(type="number" name="impacto_tiempo" placeholder="0")
        
        button.btn-submit(type="submit" style="background: #0284c7;") Registrar Cambio


  // SCRIPT PARA MODALES
  script.
    function openModal(id) { document.getElementById(id).style.display = "block"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = "none";
      }
    }