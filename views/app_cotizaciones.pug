extends layout_app

block content
  // Encabezado
  .welcome-card
    .welcome-text
      h1 Cotizaciones üìÑ
      if typeof modoDemo !== 'undefined' && modoDemo
        p.text-muted ‚ö†Ô∏è Modo demo: no existe la tabla <b>cotizaciones</b> a√∫n. La UI se muestra con datos de prueba.
      else
        p.text-muted Controla el ciclo completo: borrador ‚Üí env√≠o ‚Üí aprobaci√≥n.

    div
      button.btn.btn-success(type="button" data-bs-toggle="modal" data-bs-target="#modalNuevaCot") + Nueva Cotizaci√≥n

  // KPIs
  .stats-grid(style="margin-top: 15px;")
    .stat-card
      .stat-icon.green: i.bx.bx-check-circle
      .stat-info
        h3 #{kpis && kpis.aprobadas ? kpis.aprobadas : 0}
        p Aprobadas
    .stat-card
      .stat-icon.orange: i.bx.bx-send
      .stat-info
        h3 #{kpis && kpis.enviadas ? kpis.enviadas : 0}
        p Enviadas
    .stat-card
      .stat-icon.blue: i.bx.bx-edit
      .stat-info
        h3 #{kpis && kpis.borradores ? kpis.borradores : 0}
        p Borradores
    .stat-card
      .stat-icon.green: i.bx.bx-dollar-circle
      .stat-info
        - const money = (kpis && kpis.totalMes) ? Number(kpis.totalMes).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }) : '$0.00'
        h3 #{money}
        p Aprobado (muestra)

  // Tabla
  .card-panel(style="margin-top: 20px; padding: 20px;")
    h3(style="margin-bottom: 15px;") √öltimas cotizaciones
    .table-responsive
      table.table.table-hover.align-middle
        thead
          tr
            th Folio
            th Cliente
            th Concepto
            th Total
            th Estatus
            th Fecha
            th Acciones
        tbody
          if cotizaciones && cotizaciones.length
            each c in cotizaciones
              - const totalFmt = Number(c.total || 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' })
              - const fechaFmt = (c.fecha_creacion ? new Date(c.fecha_creacion).toLocaleDateString('es-MX') : '')
              tr
                td
                  b #{c.folio || ('COT-' + c.id)}
                td #{c.cliente}
                td #{c.concepto}
                td #{totalFmt}

                td
                  if c.estatus === 'Aprobada'
                    span.badge.bg-success Aprobada
                  else if c.estatus === 'Enviada'
                    span.badge.bg-warning.text-dark Enviada
                  else if c.estatus === 'Rechazada'
                    span.badge.bg-danger Rechazada
                  else
                    span.badge.bg-secondary Borrador

                td #{fechaFmt}
                td
                  a.btn.btn-sm.btn-outline-primary(href=`/app/finanzas/${c.id}`) Ver
          else
            tr
              td(colspan="7").text-muted No hay cotizaciones a√∫n.

  // Modal: Nueva cotizaci√≥n
  .modal.fade#modalNuevaCot(tabindex="-1" aria-hidden="true")
    .modal-dialog.modal-lg
      .modal-content
        .modal-header
          h5.modal-title Nueva cotizaci√≥n
          button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
        form(method="POST" action="/app/finanzas/crear")
          .modal-body
            .row.g-3
              .col-md-6
                label.form-label Cliente
                input.form-control(type="text" name="cliente" placeholder="Ej. Constructora X" required)
              .col-md-6
                label.form-label Estatus
                select.form-select(name="estatus")
                  option(value="Borrador" selected) Borrador
                  option(value="Enviada") Enviada
                  option(value="Aprobada") Aprobada
                  option(value="Rechazada") Rechazada

              .col-12
                label.form-label Concepto / Alcance
                input.form-control(type="text" name="concepto" placeholder="Ej. Suministro y montaje de estructura..." required)

              .col-md-4
                label.form-label Subtotal (MXN)
                input.form-control(type="number" step="0.01" min="0" id="subtotal" name="subtotal" value="0" required)
              .col-md-4
                label.form-label IVA (%)
                input.form-control(type="number" step="0.01" min="0" id="iva_porcentaje" name="iva_porcentaje" value="16" required)
              .col-md-4
                label.form-label Total estimado
                input.form-control(type="text" id="total_estimado" value="$0.00" readonly)

            hr
            p.text-muted(style="margin:0;") Tip: en la siguiente fase vamos a agregar partidas, materiales, mano de obra, PDF, env√≠o por WhatsApp/email y control de versiones.

          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-success(type="submit") Guardar

  // Script c√°lculo total (simple)
  script.
    (function() {
      const subtotal = document.getElementById('subtotal');
      const ivaPorc = document.getElementById('iva_porcentaje');
      const total = document.getElementById('total_estimado');

      function fmtMXN(n) {
        try { return Number(n).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }); }
        catch(e) { return '$' + (Number(n)||0).toFixed(2); }
      }

      function calc() {
        const st = Number(subtotal.value || 0);
        const iva = st * (Number(ivaPorc.value || 0) / 100);
        total.value = fmtMXN(st + iva);
      }

      if (subtotal && ivaPorc && total) {
        subtotal.addEventListener('input', calc);
        ivaPorc.addEventListener('input', calc);
        calc();
      }
    })();
