doctype html
html
  head
    title Reporte de Proyecto | #{p.nombre}
    // Usamos estilos inline para asegurar que el PDF los renderice bien sin buscar archivos externos
    style.
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
      
      body {
        padding: 40px;
        background: white !important;
        font-family: 'Poppins', sans-serif;
        font-size: 10pt;
        color: #334155;
        -webkit-print-color-adjust: exact; /* Importante para que salgan los colores de fondo */
      }

      /* ENCABEZADO CON LOGO */
      .detail-header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 30px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 20px;
        gap: 20px;
      }
      
      .logo-img {
        height: 60px; /* Tamaño controlado del logo */
        width: auto;
        object-fit: contain;
      }

      .header-info h1 {
        margin: 0;
        font-size: 24px;
        color: #1e293b;
      }

      .meta-tags {
        margin-top: 8px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .tag {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
        background: #f1f5f9;
        color: #475569;
      }
      .tag.navy { background: #e0f2fe; color: #0369a1; }
      .tag.green { background: #dcfce7; color: #166534; }
      
      /* TARJETAS */
      .detail-card {
        background: #fff;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        page-break-inside: avoid; /* Evita que una tarjeta se corte entre hojas */
      }

      h3 {
        margin-top: 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 8px;
        margin-bottom: 12px;
      }

      /* GRID PRINCIPAL */
      .detail-grid {
        display: flex; /* Usamos Flex para PDF (Grid a veces falla en versiones viejas de generadores) */
        gap: 20px;
      }
      .left-panel, .right-panel {
        flex: 1;
        width: 48%; /* Forzamos ancho */
      }

      /* DATOS FINANCIEROS */
      .finance-info p {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 0.95em;
      }
      .separator { border: 0; border-top: 1px dashed #cbd5e1; margin: 10px 0; }
      
      .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .red-text { color: #ef4444 !important; font-weight: bold; }
      .green-text { color: #166534 !important; font-weight: bold; }

      /* LISTAS (Riesgos, Hitos) */
      ul { padding-left: 0; list-style: none; margin: 0; }
      
      .risk-item, .timeline-item, .change-item {
        padding: 8px;
        border-bottom: 1px solid #f8fafc;
        font-size: 0.9em;
      }
      .risk-badge {
        display: inline-block;
        font-size: 0.75em;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
      }
      .risk-badge.alto { background: #fee2e2; color: #991b1b; }
      .risk-badge.bajo { background: #f0fdf4; color: #166534; }

      .timeline-content {
        display: flex;
        justify-content: space-between;
      }
      .status-label {
        font-size: 0.8em;
        text-transform: uppercase;
        color: #94a3b8;
      }

      /* SECCIONES FINALES */
      .report-sections-row {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }
      .full-width { width: 100%; }
      .half-width { flex: 1; }

  body
    // --- ENCABEZADO CON LOGO Y TÍTULO ---
    div.detail-header
      if logo
        img.logo-img(src=logo, alt="Logo INYMO")
      
      div.header-info
        h1= 'Reporte de Proyecto: ' + p.nombre
        div.meta-tags
          span.tag.navy Código: #{p.codigo}
          span.tag.green Salud: #{p.salud}
          span.tag.outline Líder: #{p.lider}
          span.tag.outline Tipo: #{p.tipo_entrega}

    // --- RESUMEN EJECUTIVO (NARRATIVA) ---
    div.detail-card.full-width
      h3 Reporte de Estatus Ejecutivo
      div.narrative-content
        p(style="white-space: pre-line")= p.narrativa || 'Sin resumen ejecutivo ingresado por el líder del proyecto.'

    // --- GRID PRINCIPAL (2 COLUMNAS) ---
    div.detail-grid
      
      // COLUMNA IZQUIERDA (Finanzas y Riesgos)
      div.left-panel
        div.detail-card
          h3 KPIs Financieros (EVM)
          div.finance-info
            p 
              span Presupuesto (BAC):
              strong $#{p.presupuesto ? p.presupuesto.toLocaleString('en-US') : '0.00'}
            p 
              span Costo Real (AC):
              strong= p.ac
            p 
              span Progreso (%):
              strong #{p.progreso}%

            hr.separator
            
            div.metric-item
              span.label CPI (Eficiencia Costo)
              strong(class=parseFloat(p.cpi) < 1.0 ? 'red-text' : 'green-text')= p.cpi
            
            div.metric-item
              span.label SPI (Eficiencia Cronograma)
              strong(class=parseFloat(p.spi) < 1.0 ? 'red-text' : 'green-text')= p.spi
              
            hr.separator
            
            div.metric-item
              span.label Estimación Final (EAC)
              strong= p.eac
            div.metric-item
              span.label Variación Costo (CV)
              strong(class=p.cv && p.cv.includes('-') ? 'red-text' : 'green-text')= p.cv

        div.detail-card
          h3 Matriz de Riesgos Principales
          ul.risk-list
            if p.riesgos && p.riesgos.length > 0
              each r in p.riesgos
                li.risk-item
                  strong= r.descripcion
                  span.risk-badge(class=r.impacto.toLowerCase())= r.impacto
            else
              li.risk-item No se han reportado riesgos críticos.

      // COLUMNA DERECHA (Hitos y Cambios)
      div.right-panel
        div.detail-card
          h3 Hitos de Entrega
          div.timeline
            if p.hitos && p.hitos.length > 0
              each h in p.hitos
                div.timeline-item
                  div.timeline-content
                    strong= h.nombre
                    span= h.fecha
                  div(style="text-align:right; margin-top:4px;")
                    span.status-label= h.estado
            else
              p No hay hitos definidos.

        div.detail-card
          h3 Control de Cambios Recientes
          ul.changes-list
            li.change-item
              strong CC-001: Ajuste de Alcance Inicial
              div(style="font-size: 0.8em; color: green;") Aprobado - Sin impacto en costo
            li.change-item
              strong CC-002: Requerimiento Extra Cliente
              div(style="font-size: 0.8em; color: orange;") En revisión - Impacto bajo

    // --- SECCIÓN INFERIOR: LECCIONES Y METAS ---
    div.report-sections-row
      
      div.detail-card.half-width
        h3 Metas y Próximos Pasos (30 días)
        p(style="font-size: 0.9em; line-height: 1.5;")= p.metas_proximos_pasos || 'No se han definido metas para el próximo periodo.'

      div.detail-card.half-width
        h3 Últimas Lecciones Aprendidas
        ul.lessons-list
          if p.leccionesAprendidas && p.leccionesAprendidas.length > 0
            each l in p.leccionesAprendidas
              li.lesson-item(style="margin-bottom: 8px;")
                strong(style="display:block; color:#475569;")= l.titulo
                span(style="font-size:0.9em;")= l.descripcion
          else
            li.lesson-item No hay lecciones registradas recientemente.

    // Pie de página discreto
    div(style="text-align: center; margin-top: 30px; color: #94a3b8; font-size: 0.8em;")
      p Generado automáticamente por Sistema INYMO el #{new Date().toLocaleDateString('es-ES')}