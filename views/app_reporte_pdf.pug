doctype html
html
  head
    title Reporte Ejecutivo | #{p.nombre}
    meta(charset="utf-8")
    style.
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
      
      body {
        font-family: 'Poppins', sans-serif;
        color: #1e293b;
        font-size: 10pt;
        padding: 40px;
        background: #fff;
        -webkit-print-color-adjust: exact; 
      }

      /* --- HEADER --- */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 2px solid #0f172a;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }
      .brand h1 { margin: 0; font-size: 24px; color: #0f172a; text-transform: uppercase; letter-spacing: 1px; }
      .brand p { margin: 2px 0 0; font-size: 9px; color: #64748b; text-transform: uppercase; }
      
      .meta-box { text-align: right; font-size: 9px; color: #475569; }
      .meta-box strong { color: #0f172a; }

      /* --- PROYECTO HERO --- */
      .project-title { font-size: 20px; font-weight: 700; margin-bottom: 5px; color: #0f172a; }
      .project-status { 
        display: inline-block; padding: 4px 10px; border-radius: 4px; 
        font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 20px;
      }
      .status-green { background: #dcfce7; color: #166534; }
      .status-red { background: #fee2e2; color: #991b1b; }

      /* --- SECCIONES --- */
      .section { margin-bottom: 25px; page-break-inside: avoid; }
      .section-title {
        font-size: 10px; font-weight: 700; text-transform: uppercase; 
        color: #64748b; border-bottom: 1px solid #e2e8f0; 
        padding-bottom: 5px; margin-bottom: 12px;
      }

      /* --- TABLAS --- */
      table { width: 100%; border-collapse: collapse; font-size: 9pt; }
      th { text-align: left; background: #f8fafc; color: #475569; padding: 8px; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
      td { padding: 8px; border-bottom: 1px solid #f1f5f9; color: #334155; }
      tr:last-child td { border-bottom: none; }

      /* --- KPI CARDS (FINANZAS) --- */
      .kpi-grid { display: flex; gap: 15px; margin-bottom: 15px; }
      .kpi-card { 
        flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; 
        border-radius: 6px; padding: 12px; text-align: center; 
      }
      .kpi-label { font-size: 8px; font-weight: 600; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px; }
      .kpi-value { font-size: 12px; font-weight: 700; color: #0f172a; font-family: monospace; }
      
      .text-success { color: #16a34a !important; }
      .text-danger { color: #dc2626 !important; }

      /* --- BADGES --- */
      .badge { padding: 2px 6px; border-radius: 3px; font-size: 8px; font-weight: 600; text-transform: uppercase; }
      .bg-gray { background: #f1f5f9; color: #475569; }
      .bg-red { background: #fef2f2; color: #b91c1c; }
      .bg-green { background: #f0fdf4; color: #15803d; }
      .bg-blue { background: #eff6ff; color: #1e40af; }

      /* --- LISTAS --- */
      .list-item { padding: 6px 0; border-bottom: 1px dashed #e2e8f0; display: flex; align-items: baseline; }
      .list-bullet { margin-right: 8px; font-size: 10px; }

  body
    //- 1. HEADER
    .header
      .brand
        if logo
           img(src=logo style="height:40px; margin-bottom:5px;")
        else
           h1 INYMO
        p Enterprise Project Management
      
      .meta-box
        div REPORTE GENERADO: <strong>#{new Date().toLocaleDateString('es-MX', {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</strong>
        div PROYECTO ID: <strong>#{p.codigo}</strong>
        div DIRECTOR (PM): <strong>#{p.lider}</strong>

    //- 2. RESUMEN DE PROYECTO
    .section
      div(style="display:flex; justify-content:space-between; align-items:flex-end;")
        div
          .project-title= p.nombre
          span.project-status(class=p.salud === 'En Tiempo' ? 'status-green' : 'status-red') ESTATUS: #{p.salud}
        
        div(style="text-align:right;")
          div(style="font-size:9px; color:#64748b; font-weight:600;") AVANCE FÍSICO REAL
          div(style="font-size:24px; font-weight:700; color:#0f172a;") #{p.progreso}%

      //- Prioridad Estratégica
      div(style="background:#f0f9ff; border:1px solid #bae6fd; padding:12px; border-radius:6px; margin-top:10px;")
        strong(style="color:#0369a1; font-size:9px; text-transform:uppercase; display:block; margin-bottom:4px;") Objetivo Estratégico (Siguiente Hito):
        div(style="color:#0c4a6e; font-size:10pt;")= p.metas_proximos_pasos || 'Definir objetivos inmediatos en plataforma.'

    //- 3. ANÁLISIS FINANCIERO (EVM)
    .section
      h3.section-title Desempeño Financiero (Earned Value)
      
      //- Fila 1: Valores Monetarios
      .kpi-grid
        .kpi-card
          span.kpi-label Presupuesto (BAC)
          span.kpi-value= p.kpi.bac_f
        .kpi-card
          span.kpi-label Valor Planeado (PV)
          span.kpi-value= p.kpi.pv_f
        .kpi-card(style="border-bottom: 2px solid #16a34a;")
          span.kpi-label Valor Ganado (EV)
          span.kpi-value.text-success= p.kpi.ev_f
        .kpi-card(style="border-bottom: 2px solid #dc2626;")
          span.kpi-label Costo Real (AC)
          span.kpi-value.text-danger= p.kpi.ac_f

      //- Fila 2: Índices de Eficiencia
      .kpi-grid
        .kpi-card
          span.kpi-label CPI (Costo)
          span.kpi-value(class=parseFloat(p.kpi.cpi_v) < 1 ? 'text-danger' : 'text-success')= p.kpi.cpi_v
        .kpi-card
          span.kpi-label SPI (Cronograma)
          span.kpi-value(class=parseFloat(p.kpi.spi_v) < 1 ? 'text-danger' : 'text-success')= p.kpi.spi_v
        .kpi-card
          span.kpi-label Variación Costo (CV)
          span.kpi-value(class=p.kpi.cv_f.includes('-') ? 'text-danger' : 'text-success')= p.kpi.cv_f
        .kpi-card
          span.kpi-label Estimado Cierre (EAC)
          span.kpi-value= p.kpi.eac_f

    //- 4. MATRIZ DE ALCANCE
    .section
      h3.section-title Entregables Clave (WBS)
      if p.entregables && p.entregables.length > 0
        table
          thead
            tr
              th(width="40%") Entregable
              th(width="25%") Responsable
              th(width="15%") Entrega
              th(width="10%") %
              th(width="10%") Estado
          tbody
            each e in p.entregables
              tr
                td(style="font-weight:600;")= e.nombre
                td= e.responsable
                td= new Date(e.fecha_entrega).toLocaleDateString('es-MX')
                td 
                  div(style="background:#e2e8f0; height:4px; width:100%; border-radius:2px; margin-bottom:2px;")
                    div(style=`background:#0f172a; height:100%; width:${e.progreso}%; border-radius:2px;`)
                  span(style="font-size:8px;") #{e.progreso}%
                td
                  span.badge.bg-gray= e.estado
      else
        div(style="color:#94a3b8; font-style:italic; padding:10px;") No hay entregables registrados.

    //- 5. DOBLE COLUMNA: CAMBIOS Y RIESGOS
    div(style="display:flex; gap:25px;")
      
      //- Columna Izquierda: Control de Cambios
      div(style="flex:1;")
        .section
          h3.section-title Gestión de Cambios
          if p.controlCambios && p.controlCambios.length > 0
            each c in p.controlCambios
              .list-item
                div(style="flex:1;")
                  strong(style="display:block; font-size:9pt;")= c.titulo
                  span(style="font-size:8pt; color:#64748b;")= c.descripcion
                div(style="text-align:right; margin-left:10px;")
                  span.badge(class=c.estatus === 'Aprobado' ? 'bg-green' : (c.estatus === 'Rechazado' ? 'bg-red' : 'bg-gray'))= c.estatus
                  if c.impacto_costo != 0
                    div(style=`font-size:8px; font-weight:700; margin-top:2px; color:${c.impacto_costo > 0 ? '#dc2626' : '#16a34a'}`) #{c.impacto_costo > 0 ? '+' : ''}$#{c.impacto_costo}
          else
            div(style="color:#94a3b8; font-size:9pt;") Sin cambios solicitados.

      //- Columna Derecha: Riesgos
      div(style="flex:1;")
        .section
          h3.section-title Matriz de Riesgos
          if p.riesgos && p.riesgos.length > 0
            each r in p.riesgos
              .list-item
                div(style="flex:1;")= r.descripcion
                span.badge(class=r.impacto === 'Alto' ? 'bg-red' : (r.impacto === 'Medio' ? 'bg-blue' : 'bg-gray') style="margin-left:10px;")= r.impacto
          else
            div(style="color:#94a3b8; font-size:9pt;") Sin riesgos activos.

    //- 6. BITÁCORA RECIENTE
    .section(style="margin-top:20px;")
      h3.section-title Bitácora de Obra (Últimos Eventos)
      if p.bitacora && p.bitacora.length > 0
        table
          tbody
            each b, index in p.bitacora
              if index < 5
                tr
                  td(width="15%" style="font-weight:600; color:#64748b;")= new Date(b.fecha_registro).toLocaleDateString('es-MX')
                  td
                    span.badge(class=b.tipo_registro === 'Incidente' ? 'bg-red' : (b.tipo_registro === 'Avance' ? 'bg-green' : 'bg-blue') style="margin-right:8px;")= b.tipo_registro
                    span= b.titulo
                  td(width="40%" style="color:#64748b; font-size:8pt;")= b.descripcion
      else
        div(style="color:#94a3b8; font-size:9pt;") Sin registros recientes.

    //- FOOTER
    div(style="position:fixed; bottom:20px; left:40px; right:40px; border-top:1px solid #e2e8f0; padding-top:10px; display:flex; justify-content:space-between; font-size:8px; color:#94a3b8;")
      div INYMO ENTERPRISE SYSTEMS - CONFIDENCIAL
      div Página 1 de 1