doctype html
html
  head
    title Reporte de Proyecto | #{p.nombre}
    style.
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
      
      body {
        padding: 30px 40px;
        background: white !important;
        font-family: 'Poppins', sans-serif;
        font-size: 9pt;
        color: #334155;
        -webkit-print-color-adjust: exact;
      }

      /* HEADER MEJORADO */
      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #0f172a;
        padding-bottom: 15px;
        margin-bottom: 25px;
      }
      .logo-img { height: 45px; object-fit: contain; }
      .header-title h1 { margin: 0; font-size: 18px; color: #0f172a; text-transform: uppercase; }
      .header-meta { font-size: 0.85em; color: #64748b; margin-top: 4px; }
      
      /* NUEVO: Stats en el Header */
      .main-stats {
        display: inline-block;
        margin-top: 8px;
        font-size: 0.9em;
        font-weight: 600;
        background: #f1f5f9;
        padding: 6px 12px;
        border-radius: 4px;
      }

      /* CARDS */
      .section-card {
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 15px;
        page-break-inside: avoid;
      }
      .section-title {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        color: #475569;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 8px;
        margin-bottom: 10px;
        margin-top: 0;
      }

      /* TABLAS */
      table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
      th { text-align: left; background: #f8fafc; padding: 6px 8px; color: #475569; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
      td { padding: 8px; border-bottom: 1px solid #f1f5f9; color: #334155; }
      tr:last-child td { border-bottom: none; }

      /* KPIs */
      .kpi-row { display: flex; gap: 15px; margin-bottom: 10px; }
      .kpi-box { 
        flex: 1; 
        background: #f8fafc; 
        padding: 10px; 
        border-radius: 6px; 
        text-align: center; 
        border: 1px solid #e2e8f0;
      }
      .kpi-label { display: block; font-size: 0.75em; color: #64748b; margin-bottom: 4px; }
      .kpi-value { display: block; font-size: 1.1em; font-weight: bold; color: #0f172a; }
      
      .text-red { color: #dc2626 !important; }
      .text-green { color: #16a34a !important; }

      /* BADGES */
      .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 600; text-transform: uppercase; }
      .bg-green { background: #dcfce7; color: #166534; }
      .bg-red { background: #fee2e2; color: #991b1b; }
      .bg-blue { background: #e0f2fe; color: #075985; }
      .bg-gray { background: #f1f5f9; color: #475569; }

      /* LOGS LIST */
      .log-item { display: flex; padding: 6px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.85em; }
      .log-date { width: 80px; color: #64748b; font-size: 0.8em; }
      .log-content { flex: 1; }
      .log-type { font-weight: 600; margin-right: 5px; font-size: 0.8em; }

  body
    // --- ENCABEZADO ---
    div.header-container
      div.header-title
        if logo
          img.logo-img(src=logo)
        else
          h2 INYMO
      div(style="text-align: right;")
        h1= p.nombre
        div.header-meta
          span COD: #{p.codigo} | 
          span Lider: #{p.lider} | 
          span #{new Date().toLocaleDateString('es-MX')}
        
        // --- NUEVO: DATOS CLAVE (AVANCE Y FECHA) ---
        div.main-stats
          span(style="color: #0f172a; margin-right: 15px;") Avance: #{p.progreso}%
          span(style="color: #2563eb;") Cierre Est: #{p.fecha_fin_ajustada_f || 'Pendiente'}

    // --- NUEVO: PRIORIDADES ESTRATÉGICAS ---
    div.section-card(style="background: #f0f9ff; border-color: #bae6fd;")
      h3.section-title(style="color: #0369a1; border-color: #bae6fd;") Prioridad Estratégica (Próximos Pasos)
      p(style="font-size: 0.9em; line-height: 1.4; margin: 0; color: #0c4a6e; font-weight: 500;")= p.metas_proximos_pasos || 'No se han definido metas estratégicas para este periodo.'

    // --- RESUMEN EJECUTIVO ---
    div.section-card
      h3.section-title Resumen Ejecutivo
      p(style="font-size: 0.9em; line-height: 1.4; margin: 0;")= p.narrativa || 'Sin información ejecutiva disponible.'

    // --- ESTADO FINANCIERO (KPIs) ---
    div.section-card
      h3.section-title Estado Financiero del Proyecto (EVM)
      div.kpi-row
        div.kpi-box
          span.kpi-label Presupuesto Total (BAC)
          span.kpi-value= p.bac_f
        div.kpi-box
          span.kpi-label Valor Ganado (EV)
          span.kpi-value= p.ev_f
        div.kpi-box
          span.kpi-label Costo Real (AC)
          span.kpi-value= p.ac_f
      
      div.kpi-row
        div.kpi-box
          span.kpi-label CPI (Costo)
          span.kpi-value(class=parseFloat(p.cpi_v) < 1 ? 'text-red' : 'text-green')= p.cpi_v
        div.kpi-box
          span.kpi-label SPI (Tiempo)
          span.kpi-value(class=parseFloat(p.spi_v) < 1 ? 'text-red' : 'text-green')= p.spi_v
        div.kpi-box
          span.kpi-label Estimado al Cierre (EAC)
          span.kpi-value= p.eac_f

    // --- MATRIZ DE ALCANCE (ENTREGABLES) ---
    div.section-card
      h3.section-title Matriz de Alcance (Entregables)
      if p.entregables && p.entregables.length > 0
        table
          thead
            tr
              th Entregable
              th Responsable
              th Progreso
              th Estado
          tbody
            each e in p.entregables
              tr
                td= e.nombre
                td= e.responsable
                td 
                  div(style="width: 100%; background: #e2e8f0; height: 6px; border-radius: 3px; display: inline-block; width: 60px; margin-right: 5px;")
                    div(style=`width: ${e.progreso}%; background: #0f172a; height: 100%; border-radius: 3px;`)
                  span(style="font-size: 0.8em;") #{e.progreso}%
                td
                  span.badge.bg-gray= e.estado
      else
        p(style="font-size: 0.85em; color: #94a3b8;") No hay entregables registrados.

    // --- DOS COLUMNAS: LECCIONES Y CAMBIOS (NUEVO DISEÑO) ---
    div(style="display: flex; gap: 20px;")
      
      // NUEVO: LECCIONES APRENDIDAS
      div(style="flex: 1;")
        div.section-card
          h3.section-title Lecciones Aprendidas
          if p.leccionesAprendidas && p.leccionesAprendidas.length > 0
            ul(style="padding:0; margin:0; list-style:none;")
              each l in p.leccionesAprendidas
                li(style="margin-bottom: 8px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 8px;")
                  strong(style="display: block; font-size: 0.85em; color: #334155;")= l.titulo
                  span(style="font-size: 0.8em; color: #64748b;")= l.descripcion
          else
             p(style="font-size: 0.85em; color: #94a3b8;") No hay lecciones registradas.

      // CONTROL DE CAMBIOS
      div(style="flex: 1;")
        div.section-card
          h3.section-title Control de Cambios
          if p.controlCambios && p.controlCambios.length > 0
            table
              tbody
                each c in p.controlCambios
                  tr
                    td
                      div(style="display:flex; justify-content: space-between;")
                        strong= c.titulo
                        span.badge(class=(c.estatus === 'Aprobado' ? 'bg-green' : (c.estatus === 'Rechazado' ? 'bg-red' : 'bg-gray')))= c.estatus
                      div(style="font-size: 0.8em; margin-top: 4px;")
                        if c.impacto_costo != 0
                          span(class=c.impacto_costo > 0 ? 'text-red' : 'text-green') #{c.impacto_costo > 0 ? '+' : ''}$#{c.impacto_costo} 
                        if c.impacto_tiempo != 0
                          span(class=c.impacto_tiempo > 0 ? 'text-red' : 'text-green' style="margin-left: 8px;") #{c.impacto_tiempo > 0 ? '+' : ''}#{c.impacto_tiempo}d
          else
            p(style="font-size: 0.85em; color: #94a3b8;") Sin cambios registrados.

    // --- RIESGOS ---
    div.section-card
      h3.section-title Matriz de Riesgos
      if p.riesgos && p.riesgos.length > 0
        table
          tbody
            each r in p.riesgos
              tr
                td 
                  strong(style="display: block; font-size: 0.9em;")= r.descripcion
                  span.badge(class=(r.impacto === 'Alto' ? 'bg-red' : (r.impacto === 'Medio' ? 'bg-blue' : 'bg-green'))) Impacto: #{r.impacto}
      else
        p(style="font-size: 0.85em; color: #94a3b8;") Sin riesgos activos.

    // --- HISTORIAL DE BITÁCORA ---
    div.section-card
      h3.section-title Bitácora de Actividades Recientes
      if p.bitacora && p.bitacora.length > 0
        each b in p.bitacora
          div.log-item
            div.log-date= new Date(b.fecha_registro).toLocaleDateString('es-MX', {day: '2-digit', month: 'short'})
            div.log-content
              span.log-type(class=(b.tipo_registro === 'Incidente' ? 'text-red' : (b.tipo_registro === 'Avance' ? 'text-green' : 'text-blue')))= b.tipo_registro
              span= b.titulo
      else
        p(style="font-size: 0.85em; color: #94a3b8;") No hay actividad reciente registrada.

    // --- PIE DE PÁGINA ---
    div(style="text-align: center; border-top: 1px solid #e2e8f0; padding-top: 10px; font-size: 0.7em; color: #94a3b8;")
      p Reporte generado automáticamente por la plataforma INYMO. Información confidencial.