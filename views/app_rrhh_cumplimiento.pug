extends layout_app

block content
  //- =========================================================================
  //- INYMO COMPLIANCE ENGINE - DIVISIN 09: CUMPLIMIENTO Y RIESGOS
  //- =========================================================================
  //- Est谩ndares: ISO 45001 (Seguridad) & LFT (Legal M茅xico)
  //- Versi贸n: 1.2.0 - "Escudo Industrial"
  
  style.
    /* --- ARQUITECTURA DE DISEO NORMATIVO (INTERNAL CSS) --- */
    :root {
      --inymo-navy: #0f172a;
      --inymo-green: #8cc63f;
      --hse-orange: #f97316;
      --hse-red: #ef4444;
      --glass-white: rgba(255, 255, 255, 0.98);
      --shadow-lux: 0 15px 30px -5px rgba(0, 0, 0, 0.05);
    }

    .compliance-container {
      animation: fadeInCompliance 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes fadeInCompliance {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Tarjetas de Indicadores Cr铆ticos */
    .stat-card-hse {
      border: none;
      border-radius: 35px;
      background: white;
      box-shadow: var(--shadow-lux);
      transition: all 0.4s ease;
      border: 1px solid #f1f5f9;
      overflow: hidden;
    }

    .stat-card-hse:hover {
      transform: translateY(-10px);
      box-shadow: 0 30px 60px -15px rgba(15, 23, 42, 0.12);
    }

    .icon-box-hse {
      width: 65px;
      height: 65px;
      border-radius: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
    }

    /* Listado de Incidentes y Auditor铆as */
    .compliance-table-wrapper {
      background: white;
      border-radius: 40px;
      padding: 40px;
      border: 1px solid #f1f5f9;
      box-shadow: 0 4px 20px rgba(0,0,0,0.01);
    }

    .table-hse {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 15px;
    }

    .table-hse th {
      color: #94a3b8;
      font-weight: 800;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 2px;
      padding: 10px 25px;
    }

    .table-hse td {
      padding: 22px 25px;
      background: #f8fafc;
      border: none;
      vertical-align: middle;
    }

    .table-hse td:first-child { border-radius: 20px 0 0 20px; }
    .table-hse td:last-child { border-radius: 0 20px 20px 0; }

    .table-hse tr:hover td {
      background: #f1f5f9;
      transform: scale(1.005);
    }

    /* Mapa de Riesgos Estilizado */
    .risk-heat-map {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 25px;
    }

    .risk-cell {
      padding: 25px;
      border-radius: 25px;
      text-align: center;
      color: white;
      font-weight: 700;
      transition: 0.3s;
    }
    .risk-high { background: var(--hse-red); box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3); }
    .risk-med { background: var(--hse-orange); box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3); }
    .risk-low { background: var(--inymo-green); box-shadow: 0 10px 20px rgba(140, 198, 63, 0.3); }

    /* Modales de HSE */
    .modal-hse {
      border-radius: 45px;
      border: none;
    }

    .hse-label {
      font-size: 0.8rem;
      font-weight: 800;
      color: var(--inymo-navy);
      text-transform: uppercase;
      margin-bottom: 12px;
      display: block;
    }

    .hse-input {
      border-radius: 20px;
      padding: 16px 25px;
      background: #f1f5f9;
      border: 2px solid transparent;
      transition: 0.3s;
    }

    .hse-input:focus {
      background: white;
      border-color: var(--hse-orange);
      box-shadow: 0 0 0 6px rgba(249, 115, 22, 0.1);
      outline: none;
    }

    .severity-badge {
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 0.65rem;
      font-weight: 800;
      text-transform: uppercase;
    }

  .container-fluid.py-4.compliance-container
    //- --- BREADCRUMB ---
    nav.mb-4(aria-label="breadcrumb")
      ol.breadcrumb.bg-transparent.p-0.small
        li.breadcrumb-item: a.text-muted.text-decoration-none(href="/app/rrhh")  Capital Humano
        li.breadcrumb-item.active.fw-bold.text-dark(aria-current="page") 09. Cumplimiento Legal y HSE

    //- --- CABECERA DE SEGURIDAD ---
    .d-flex.justify-content-between.align-items-start.mb-5
      div
        .d-flex.align-items-center.mb-2
          span.p-3.bg-dark.text-white.rounded-4.me-4.shadow-lg
            i.bx.bx-error-circle.fs-2
          div
            h1.fw-bold.text-dark.mb-1 Monitoreo de Riesgos y Cumplimiento
            p.text-muted.mb-0 
              i.bx.bx-shield-quarter.text-danger.me-1
              | Supervisi贸n de integridad f铆sica, legal y ambiental para el personal de INYMO.
      
      div.d-flex.gap-3
        button.btn.btn-outline-dark.shadow-sm.px-4.py-3.rounded-pill.fw-bold
          i.bx.bx-file-export.me-2
          | Reporte LFT
        button.btn.btn-dark.shadow-sm.px-4.py-3.rounded-pill.fw-bold(data-bs-toggle="modal" data-bs-target="#modalReportarHSE")
          i.bx.bx-bolt-circle.me-2
          | Reportar Incidente

    //- --- FILA 1: KPIs DE SEGURIDAD (HSE) ---
    .row.g-4.mb-5
      .col-md-4.col-xl-3
        .stat-card-hse.p-4
          .icon-box-hse.bg-success.bg-opacity-10.text-success
            i.bx.bx-check-shield
          small.text-uppercase.fw-bold.text-muted D铆as sin Accidentes
          h2.fw-bold.mt-2.mb-0 412
          p.x-small.text-muted.mt-2 Basado en registros de obra Q4.

      .col-md-4.col-xl-3
        .stat-card-hse.p-4
          .icon-box-hse.bg-warning.bg-opacity-10.text-warning
            i.bx.bx-alarm-exclamation
          small.text-uppercase.fw-bold.text-muted Alertas Vencidas (IMSS)
          h2.fw-bold.mt-2.mb-0= (stats && stats.alertas_vencidas) ? stats.alertas_vencidas : '0'
          p.x-small.text-muted.mt-2 Tr谩mites legales pendientes.

      .col-md-4.col-xl-3
        .stat-card-hse.p-4
          .icon-box-hse.bg-primary.bg-opacity-10.text-primary
            i.bx.bx-book-content
          small.text-uppercase.fw-bold.text-muted Auditor铆as HSE
          h2.fw-bold.mt-2.mb-0= (stats && stats.tramites_hse) ? stats.tramites_hse : '0'
          p.x-small.text-muted.mt-2 Evaluaciones de entorno laboral.

      .col-md-4.col-xl-3
        .stat-card-hse.p-4
          .icon-box-hse.bg-danger.bg-opacity-10.text-danger
            i.bx.bx-shield-x
          small.text-uppercase.fw-bold.text-muted Riesgo Actual
          h2.fw-bold.mt-2.mb-0 BAJO
          .progress.mt-3(style="height: 8px; border-radius: 10px;")
            .progress-bar.bg-success(style="width: 15%")

    //- --- FILA 2: MAPA DE CALOR Y CUMPLIMIENTO ---
    .row.g-5.mb-5
      .col-xl-4
        .stat-card-hse.p-5
          h4.fw-bold.text-dark.mb-1 Matriz de Riesgos Q4
          p.small.text-muted Priorizaci贸n de peligros operativos.
          
          .risk-heat-map
            .risk-cell.risk-high 2
              small.d-block.x-small Cr铆ticos
            .risk-cell.risk-med 5
              small.d-block.x-small Moderados
            .risk-cell.risk-low 18
              small.d-block.x-small Seguros
          
          .mt-5.pt-4.border-top
            h6.fw-bold.small.text-uppercase.letter-spacing-1 Pr贸xima Renovaci贸n Civil
            .d-flex.justify-content-between.align-items-center.mt-3
              span.badge.bg-light.text-dark.px-3 Enero 15, 2026
              span.text-danger.fw-bold 28 d铆as

      .col-xl-8
        .compliance-table-wrapper
          .d-flex.justify-content-between.align-items-center.mb-5
            div
              h4.fw-bold.text-dark.mb-1 Bit谩cora de Incidentes y Hallazgos
              p.small.text-muted Historial de seguridad y salud en el trabajo.
            span.badge.bg-light.text-dark.border.px-3 Q4 Audit

          .table-responsive
            table.table-hse
              thead
                tr
                  th Fecha / Tipo
                  th Descripci贸n del Hallazgo
                  th Gravedad
                  th Reportado por
                  th Acci贸n
              tbody
                if incidentes && incidentes.length > 0
                  each i in incidentes
                    tr
                      td
                        .fw-bold.text-dark= formatDate(i.fecha_incidente).split(' ')[0]
                        small.text-muted= i.tipo
                      td
                        p.small.mb-0.text-truncate(style="max-width: 250px;")= i.descripcion
                      td
                        span.severity-badge(class=`bg-${i.gravedad == 'Alta' ? 'danger' : 'warning'} bg-opacity-10 text-${i.gravedad == 'Alta' ? 'danger' : 'warning'}`)
                          | #{i.gravedad}
                      td
                        span.small.fw-bold= i.reportado_por
                      td
                        button.btn.btn-light.btn-sm.rounded-pill
                          i.bx.bx-search-alt
                else
                  tr: td.text-center.py-5(colspan="5")
                    img(src="/images/safe-illustration.svg" style="width: 100px; opacity: 0.1;")
                    p.text-muted.mt-3 No se han detectado incidentes en este periodo.

    //- --- SECCIN: CHECKLIST DE CUMPLIMIENTO LFT ---
    .row.g-4
      .col-xl-6
        .stat-card-hse.p-5
          h5.fw-bold.text-dark.mb-4 锔 Cumplimiento Normativo (LFT/IMSS)
          ul.list-group.list-group-flush
            li.list-group-item.px-0.py-3.bg-transparent.d-flex.justify-content-between.align-items-center
              div
                h6.fw-bold.mb-0 Contratos Individuales de Trabajo
                p.x-small.text-muted.mb-0 100% Digitalizados y Firmados.
              i.bx.bxs-check-circle.text-success.fs-3
            li.list-group-item.px-0.py-3.bg-transparent.d-flex.justify-content-between.align-items-center
              div
                h6.fw-bold.mb-0 Altas y Movimientos IMSS/IDSE
                p.x-small.text-muted.mb-0 Conciliado con SUA Diciembre.
              i.bx.bxs-check-circle.text-success.fs-3
            li.list-group-item.px-0.py-3.bg-transparent.d-flex.justify-content-between.align-items-center
              div
                h6.fw-bold.mb-0 Reglamento Interior de Trabajo
                p.x-small.text-muted.mb-0 Depositado en el Centro Federal de Conciliaci贸n.
              i.bx.bxs-info-circle.text-primary.fs-3

      .col-xl-6
        .stat-card-hse.p-5.bg-dark.text-white
          h5.fw-bold.mb-4  Equipo de Protecci贸n Personal (EPP)
          p.small.opacity-50 Control de inventario de seguridad industrial.
          
          .mt-4
            .d-flex.justify-content-between.mb-2
              small.fw-bold Cascos de Seguridad
              small.fw-bold 95%
            .progress.bg-white.bg-opacity-10(style="height: 6px;")
              .progress-bar.bg-success(style="width: 95%")
          
          .mt-4
            .d-flex.justify-content-between.mb-2
              small.fw-bold Calzado Diel茅ctrico
              small.fw-bold 82%
            .progress.bg-white.bg-opacity-10(style="height: 6px;")
              .progress-bar.bg-warning(style="width: 82%")

          .mt-5.p-4.rounded-4(style="background: rgba(140, 198, 63, 0.1); border: 1px dashed var(--inymo-green);")
            .d-flex.align-items-center
              i.bx.bx-check-shield.text-success.fs-3.me-3
              p.small.mb-0 Pr贸xima auditor铆a externa programada para el **12 de Enero 2026**.

    //- =========================================================================
    //- MODALES DE HSE
    //- =========================================================================
    #modalReportarHSE.modal.fade(tabindex="-1" aria-hidden="true")
      .modal-dialog.modal-lg.modal-dialog-centered
        .modal-content.modal-hse
          form(action="/app/rrhh/division/09/hse/reportar" method="POST")
            .modal-header.p-5.bg-dark.text-white.border-0
              div
                h3.fw-bold.mb-1 Reporte de Incidente / Hallazgo
                p.mb-0.opacity-50 Protocolo de Seguridad Industrial INYMO.
              button.btn-close.btn-close-white(data-bs-dismiss="modal")
            
            .modal-body.p-5
              .row.g-4
                .col-md-6
                  label.hse-label Tipo de Evento
                  select.form-select.hse-input(name="tipo" required)
                    option(value="Accidente")  Accidente de Trabajo
                    option(value="Incidente") 锔 Incidente (Casi-Accidente)
                    option(value="Hallazgo")  Hallazgo Inseguro
                    option(value="Enfermedad")  Salud Ocupacional
                
                .col-md-6
                  label.hse-label Fecha y Hora
                  input.form-control.hse-input(type="datetime-local" name="fecha" required)

                .col-12
                  label.hse-label Descripci贸n de los Hechos
                  textarea.form-control.hse-input(name="description" rows="4" placeholder="Describa a detalle qu茅 ocurri贸, d贸nde y qui茅nes estuvieron involucrados..." required)

                .col-md-6
                  label.hse-label Gravedad Estimada
                  select.form-select.hse-input(name="gravedad" required)
                    option(value="Baja")  Baja - Sin incapacidad
                    option(value="Media")  Media - Requiere primeros auxilios
                    option(value="Alta")  Alta - Incapacitante
                    option(value="Critica")  Cr铆tica - Emergencia Hospitalaria

            .modal-footer.p-5.bg-light.border-0
              button.btn.btn-link.text-muted.text-decoration-none.fw-bold(data-bs-dismiss="modal") Cancelar
              button.btn.btn-dark.px-5.py-3.rounded-pill.fw-bold.shadow-lg(type="submit")
                i.bx.bx-plus-medical.me-2
                | Vincular Plan de Acci贸n

  //- --- SCRIPTS DE INTELIGENCIA ---
  script.
    document.addEventListener('DOMContentLoaded', () => {
      console.log(" INYMO HSE Engine initialized.");
    });