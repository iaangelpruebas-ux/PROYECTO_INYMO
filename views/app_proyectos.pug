extends layout_app

block content
  // Conectamos el CSS espec铆fico de este m贸dulo
  link(rel='stylesheet', href='/stylesheets/proyectos.css')

  // --- CABECERA DEL MDULO ---
  div.module-header(style="margin-bottom: 25px;")
    div.header-title
      h1 Gesti贸n de Portafolio Estrat茅gico
      p.subtitle Monitoreo de Desempe帽o y Gobernanza (PMO)
    
    // Bot贸n de Acci贸n Principal
    a.btn-new-project(href="/app/proyectos/nuevo") 
      i.bx.bx-plus 
      | Nuevo Proyecto

  // ==========================================================
  //  PUNTO 1.1: COMMAND CENTER (KPIs GLOBALES)
  // ==========================================================
  div.command-center(style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;")
    div.kpi-card(style="background: #1e293b; color: white; padding: 20px; border-radius: 12px; border-left: 5px solid #38bdf8; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);")
      div(style="display: flex; justify-content: space-between; align-items: start;")
        span(style="font-size: 0.75em; font-weight: 600; color: #94a3b8; text-transform: uppercase;") SPI Global
        i.bx.bx-time-five(style="color: #38bdf8; font-size: 1.2rem;")
      h2(style="margin: 10px 0; font-size: 1.8rem;")= stats.spi
      p(style="font-size: 0.7em; color: #cbd5e1;") ndice de desempe帽o cronograma

    div.kpi-card(style="background: #1e293b; color: white; padding: 20px; border-radius: 12px; border-left: 5px solid #4ade80; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);")
      div(style="display: flex; justify-content: space-between; align-items: start;")
        span(style="font-size: 0.75em; font-weight: 600; color: #94a3b8; text-transform: uppercase;") CPI Global
        i.bx.bx-trending-up(style="color: #4ade80; font-size: 1.2rem;")
      h2(style="margin: 10px 0; font-size: 1.8rem;")= stats.cpi
      p(style="font-size: 0.7em; color: #cbd5e1;") Eficiencia de costos del portafolio

    div.kpi-card(style="background: #1e293b; color: white; padding: 20px; border-radius: 12px; border-left: 5px solid #fb7185; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);")
      div(style="display: flex; justify-content: space-between; align-items: start;")
        span(style="font-size: 0.75em; font-weight: 600; color: #94a3b8; text-transform: uppercase;") Exposici贸n al Riesgo
        i.bx.bx-error-circle(style="color: #fb7185; font-size: 1.2rem;")
      h2(style="margin: 10px 0; font-size: 1.8rem;") #{stats.riesgo}%
      p(style="font-size: 0.7em; color: #cbd5e1;") Proyectos con estatus cr铆tico

    div.kpi-card(style="background: #1e293b; color: white; padding: 20px; border-radius: 12px; border-left: 5px solid #fbbf24; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);")
      div(style="display: flex; justify-content: space-between; align-items: start;")
        span(style="font-size: 0.75em; font-weight: 600; color: #94a3b8; text-transform: uppercase;") Valor Ganado (EV)
        i.bx.bx-dollar-circle(style="color: #fbbf24; font-size: 1.2rem;")
      h2(style="margin: 10px 0; font-size: 1.8rem;")= stats.evTotal
      p(style="font-size: 0.7em; color: #cbd5e1;") Capital devengado total (Acumulado)

  // --- CONTENEDOR DE HERRAMIENTAS (DISEO LIMPIO) ---
  div.tools-container(style="background: #fff; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);")
    
    // NIVEL 1: FILTROS Y TOTAL
    div(style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;")
      div.filter-group(style="display: flex; gap: 10px; flex-wrap: wrap;")
        a.filter-btn(href="/app/proyectos?filter=todos" class=activeFilter === 'todos' ? 'active' : '') Todos
        a.filter-btn(href="/app/proyectos?filter=en-tiempo" class=activeFilter === 'en-tiempo' ? 'active' : '') En Tiempo
        a.filter-btn(href="/app/proyectos?filter=retrasados" class=activeFilter === 'retrasados' ? 'active' : '') Retrasados
        a.filter-btn(href="/app/proyectos?filter=en-riesgo" class=activeFilter === 'en-riesgo' ? 'active' : '') En Riesgo
        a.filter-btn(href="/app/proyectos?filter=predictivos" class=activeFilter === 'predictivos' ? 'active' : '') Predictivo
        a.filter-btn(href="/app/proyectos?filter=hibrido" class=activeFilter === 'hibrido' ? 'active' : '') H铆brido
        a.filter-btn(href="/app/proyectos?filter=agiles" class=activeFilter === 'agiles' ? 'active' : '') gil
      
      div.total-invested(style="text-align: right;")
        span(style="color: #64748b; font-size: 0.8em; text-transform: uppercase; font-weight: 600;") Inversi贸n Total: 
        strong(style="color: #166534; font-size: 1.2rem; display: block;") $#{totalValorNegocio}

    // --- BARRA DE BSQUEDA Y FILTROS ---
    div.toolbar(style="display: flex; gap: 15px; margin-bottom: 25px; align-items: center;")
      
      // 1. EL BUSCADOR (Corregido con Flexbox)
      form.search-box(action="/app/proyectos" method="GET" style="flex-grow: 1; display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 5px 5px 5px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);")
        
        // Icono Lupa
        i.bx.bx-search(style="font-size: 1.2em; color: #94a3b8; margin-right: 10px;")
        
        // Input (ocupa todo el espacio disponible)
        input(
          type="text" 
          name="q" 
          placeholder="Buscar por nombre, c贸digo o cliente..." 
          value=searchTerm 
          style="border: none; outline: none; flex-grow: 1; font-size: 0.95em; color: #334155; background: transparent;"
        )
        
        // Bot贸n Buscar (No se encoge)
        button(type="submit" style="background: #1e293b; color: #fff; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; flex-shrink: 0; margin-left: 10px;") Buscar

      // 2. BOTN ARCHIVADOS (Al lado)
      a.btn-secondary(href="/app/proyectos?filter=archivados" style="background: #fff; border: 1px solid #cbd5e1; color: #475569; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: flex; align-items: center; gap: 8px; font-weight: 500; white-space: nowrap;")
        i.bx.bx-archive
        | Archivados

  // --- GRID DE PROYECTOS (PORTAFOLIO) ---
  div.projects-grid
    each p in proyectos
      a.project-card(href=`/app/proyectos/${p.id}` class=p.riesgo === 'Alto' ? 'risk-alert' : '')
        div.card-header
          span.project-code= p.codigo
          span.badge-type(class=p.tipo_entrega.toLowerCase())= p.tipo_entrega
        
        div.card-body
          h3= p.nombre
          p.client-name
            i.bx.bx-building 
            |  #{p.cliente}
          
          div.meta-info
            div.meta-item
              span.label Fase
              span.value= p.fase
            div.meta-item
              span.label L铆der
              span.value= p.lider

          div.progress-container
            div.progress-labels
              span Avance T茅cnico
              span #{p.progreso}%
            div.progress-bar-bg
              div.progress-bar-fill(style=`width: ${p.progreso}%`)

        div.card-footer
          div.finance-data
            div
              span.label Presupuesto
              //- Usamos 'es-MX' para asegurar formato de pesos mexicanos con comas
              strong $#{p.presupuesto.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            div
              span.label Valor Negocio
              strong.value-green $#{p.valor_negocio.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
          
          div.status-pill(class=p.salud.toLowerCase().replace(' ', '-'))
            i.bx.bxs-circle
            |  #{p.salud}

  // --- FOOTER PMO ---
  div(style="text-align: center; margin-top: 40px; color: #94a3b8; font-size: 0.8em; border-top: 1px solid #e2e8f0; padding-top: 20px;")
    p Sistema de Inteligencia de Proyectos INYMO 漏 2025 | Datos calculados en tiempo real.